# ✈️ Aviation DWH — Аналитика авиаперевозок США

> Хранилище данных для анализа отмен и задержек рейсов по аэропортам США.  
> Командный учебный проект по дата-инжинирингу.

---

## О чём этот проект

Мы взяли реальные данные о рейсах США и задали следующий вопрос:  
**почему рейсы отменяют — и можно ли предсказать, когда это произойдёт?**

Оказалось, что погода — причина 67–79% всех отмен.  
Этот проект строит инфраструктуру, чтобы это доказать: 4-слойное хранилище данных,  
8 пайплайнов в Airflow и живой дашборд в Yandex DataLens.

---

## Что внутри

```
aviation-dwh/
├── sql/
│   └── dm_layer_queries.sql     # все 4 SQL-запроса аналитических витрин
└── docs/
    ├── architecture.md          # архитектура по слоям, таблицы, ETL-пайплайны
    └── report.md                # аналитические выводы и описание дашборда
```

---

## Стек

| Инструмент | Зачем |
|---|---|
| **PostgreSQL** | хранилище всех 4 слоёв DWH |
| **Apache Airflow** | оркестрация 8 DAG-ов ETL-пайплайна |
| **Yandex DataLens** | BI-дашборд — 7 чартов, живые данные |
| **S3** | хранение исходных файлов рейсов |
| **METAR-архив** | почасовые метеонаблюдения по аэропортам |

---

## Как движутся данные

```
[BTS рейсы]      [OurAirports]     [METAR погода]
      │                │                  │
      ▼                ▼                  ▼
  ods.flights      ods.airport        ods.weather
      │                                   │
      ▼───────────────────────────────────▼
  stg.flights                      stg.weather
  (очистка, дедупликация,          (нормализация,
   приведение timestamp)            ICAO-коды)
      │                                   │
      ▼───────────────────────────────────▼
  dds.success_flights               dds.weather ← SCD2
  dds.cancel_flights                dds.airport
      │
      ▼
  dm.success_flights          dm.dep_arr_report
  dm.cancel_flights           dm.cancellation_report
      │
      ▼
  Дашборд Yandex DataLens
```

---

## Ключевые выводы

После того как всё заработало, данные показали следующее:

- **Погода — причина 67–79% отмен** по всем 4 аэропортам (код B)
- **Январь — худший месяц**: пик отмен, особенно в аэропорту AVL
- **Большинство задержек — 5–7 минут**, но хвост распределения достигает 150 минут
- **Снег в BIS снижает среднюю температуру до −7°C** — сильный предиктор отмен
- **Маршруты концентрируются на хабах** — AVL отправляет больше всего рейсов в LGA, ORD, DFW

---

## Пайплайн подробнее

9 DAG-ов в Airflow, все с тегом `team11test`, запускаются последовательно:

**Слой ODS** — загрузка сырых данных из источников
- `Azimova_flights_ods_11` — парсинг файлов рейсов из S3
- `Azimova_k_airport_ods_11` — загрузка справочника аэропортов
- `Azimova_weather_ods_11` — обработка METAR-архивов по ICAO-кодам

**Слой STG** — очистка и нормализация
- `azimovak_flights_stg_11` — приведение timestamp, дедупликация по `(рейс, дата, вылет, прилёт)`
- `azimova_weather_stg_11` — нормализация полей погоды, удаление дублей

**Слой DDS** — построение хранилища
- `azimova_airport_dds_11` — справочник аэропортов с surrogate key
- `azimova_flights_dds_11` — разделение рейсов на выполненные и отменённые
- `azimova_weather_dds_11` — история изменений погоды (SCD2)

**Слой DM** — аналитические витрины
- `krasovskayas_dm_flights_full_etl` — один DAG создаёт все 4 DM-таблицы

---

## Дашборд

7 чартов в Yandex DataLens, подключены к слоям DM и DDS:

| № | Чарт | На какой вопрос отвечает |
|---|---|---|
| 1 | Карта аэропортов | Где самые загруженные аэропорты? Какой у них процент отмен? |
| 2 | Дальность рейсов по направлениям | Из каких аэропортов летят дальние рейсы? |
| 3 | Отмены по месяцам | В какие периоды выше риск? |
| 4 | Причины отмен по аэропортам | Что доминирует в каждом аэропорту? |
| 5 | Распределение рейсов (tree-map) | Какие направления самые загруженные? |
| 6 | Гистограммы задержек | Насколько плохи задержки в каждом аэропорту? |
| 7 | Температура и снег | Какая погода предшествует отменам? |

---

## Источники данных

| Источник | Что предоставляет |
|---|---|
| [BTS — Bureau of Transportation Statistics](https://www.transtats.bts.gov) | Записи рейсов США: времена, задержки, коды отмен |
| [OurAirports](https://ourairports.com) | Справочник аэропортов: IATA/ICAO-коды, координаты, город, регион |
| METAR-архив | Почасовая погода: температура, давление, скорость ветра, видимость, облачность |

---

## Аэропорты в проекте

| Код | Город | Штат |
|---|---|---|
| AVL | Asheville | North Carolina |
| FAY | Fayetteville | North Carolina |
| BIS | Bismarck | North Dakota |
| GFK | Grand Forks | North Dakota |

---

## Команда

Проект выполнен командой из 4 человек в рамках курса ФКН ВШЭ по дата-инжинирингу (Группа 11).

---

Все запросы DM-слоя — в [`sql/dm_layer_queries.sql`](sql/dm_layer_queries.sql).  
Архитектура по слоям: [`docs/architecture.md`](docs/architecture.md)  
Аналитические выводы: [`docs/report.md`](docs/report.md)
