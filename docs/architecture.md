# Архитектура: Aviation DWH

## Общая схема

4-слойное хранилище данных для анализа рейсов и метеоусловий в США.  
Связывает исторические данные о рейсах с почасовыми метеонаблюдениями для анализа задержек и отмен.

```
[S3 / BTS]          [OurAirports]        [METAR-архив]
     │                    │                     │
     ▼                    ▼                     ▼
 ods.flights          ods.airport           ods.weather
         └──────────────┴──────────────────────┘
                         │
                         ▼  (очистка, дедупликация, нормализация)
                   stg.flights
                   stg.weather
                         │
                         ▼  (surrogate keys, SCD2, разделение по статусу)
              dds.success_flights   dds.cancel_flights
              dds.airport           dds.weather (SCD2)
                         │
                         ▼  (агрегация, джойны, отчёты)
         dm.success_flights     dm.cancel_flights
         dm.dep_arr_report      dm.cancellation_report
         dm.weather_flights
                         │
                         ▼
                  Yandex DataLens
```

---

## Слой 1 — ODS (Operational Data Store)

Сырые данные, загруженные как есть из источников. Никаких трансформаций не применяется.

| Таблица | Источник | Описание |
|---|---|---|
| `ods.flights` | [BTS transtats.bts.gov](https://www.transtats.bts.gov) | Сырые записи рейсов США: даты, времена, задержки, коды отмен |
| `ods.airport` | [OurAirports ourairports.com](https://ourairports.com) | Справочник аэропортов: IATA/ICAO-коды, координаты, названия |
| `ods.weather` | METAR-архив | Сырые почасовые метеонаблюдения по ICAO-кодам |

---

## Слой 2 — STG (Staging)

Очистка и нормализация перед загрузкой в DDS. Обеспечивает согласованность данных для джойнов.

| Таблица | Ключевые трансформации |
|---|---|
| `stg.flights` | Приведение текстовых дат → `TIMESTAMP` и `TIME`; дедупликация по `(рейс, дата, вылет, прилёт)`; добавление `processed_dttm` |
| `stg.weather` | Выделение ключевых полей (осадки, температура, ветер); очистка некорректных строк; дедупликация по timestamp |

**Зачем нужен этот слой:**  
STG изолирует логику очистки от сырых источников. Если источник изменит формат — меняется только STG-DAG, DDS и DM остаются нетронутыми.

---

## Слой 3 — DDS (Detail Data Store)

Нормализованные таблицы фактов и измерений с surrogate key. Здесь применяется бизнес-логика.

| Таблица | Тип | Описание |
|---|---|---|
| `dds.success_flights` | Факт | Только выполненные рейсы (`cancelled_flg = 0`) |
| `dds.cancel_flights` | Факт | Только отменённые рейсы (`cancelled_flg = 1`) |
| `dds.airport` | Измерение | Нормализованный справочник аэропортов с surrogate key (`airport_rk`) |
| `dds.weather` | Измерение (SCD2) | Метеонаблюдения с полной историей изменений |

**Ключевые архитектурные решения:**

- **Раздельные таблицы фактов** для выполненных и отменённых рейсов: упрощает расчёт процентов выполнения и анализ причин отмен без `WHERE`-фильтров в каждом запросе
- **Surrogate key для аэропортов**: отвязывает внутренний ID от изменений IATA-кода
- **SCD2 для погоды**: сохраняет полную почасовую историю, позволяет делать point-in-time джойны между рейсом и погодой в момент вылета

---

## Слой 4 — DM (Data Marts)

Предагрегированные аналитические таблицы. Каждая витрина отвечает на один бизнес-вопрос.

| Таблица | Гранулярность | Бизнес-вопрос |
|---|---|---|
| `dm.success_flights` | Рейс | Какие рейсы выполнены? Каковы задержки? |
| `dm.cancel_flights` | Рейс | Какие рейсы отменены и почему? |
| `dm.dep_arr_report` | Аэропорт × Час | Сколько вылетов/прилётов в каждом аэропорту по часам? Средние задержки? |
| `dm.cancellation_report` | Аэропорт × Час × Погода | Какие погодные условия коррелируют с отменами? |
| `dm.weather_flights` | Рейс × Погода | Полная интеграция рейсов с метеоданными |

**Зачем предагрегировать в DM:**  
Тяжёлые джойны (рейсы ↔ аэропорты ↔ погода) выполняются один раз при ETL, а не при каждом запросе дашборда. DataLens подключается напрямую к DM-таблицам.

---

## ETL-пайплайны (Apache Airflow)

Все DAG-и с тегом: `team11test`

### Загрузка ODS

| DAG | Целевая таблица | Описание |
|---|---|---|
| `Azimova_flights_ods_11` | `ods.flights` | Парсинг файлов рейсов из S3, загрузка в ODS |
| `Azimova_k_airport_ods_11` | `ods.airport` | Загрузка справочника аэропортов |
| `Azimova_weather_ods_11` | `ods.weather` | Обработка сырых METAR-архивов по ICAO-кодам |

### Загрузка STG

| DAG | Целевая таблица | Описание |
|---|---|---|
| `azimovak_flights_stg_11` | `stg.flights` | Приведение timestamp, дедупликация, добавление `processed_dttm` |
| `azimova_weather_stg_11` | `stg.weather` | Нормализация полей погоды, выделение ICAO-кодов, удаление дублей |

### Загрузка DDS

| DAG | Целевая таблица | Описание |
|---|---|---|
| `azimova_airport_dds_11` | `dds.airport` | Нормализованный справочник аэропортов с surrogate key |
| `azimova_flights_dds_11` | `dds.success_flights`, `dds.cancel_flights` | Разделение STG-рейсов по флагу отмены |
| `azimova_weather_dds_11` | `dds.weather` | Построение SCD2-истории погоды |

### Загрузка DM

| DAG | Целевая таблица | Описание |
|---|---|---|
| `krasovskayas_dm_flights_full_etl` | Все 4 DM-таблицы | Один DAG создаёт все витрины из слоя DDS |

**Порядок выполнения:**
```
ODS DAG-и → STG DAG-и → DDS DAG-и → DM DAG
```

---

## Источники данных

| Источник | Данные | Периодичность |
|---|---|---|
| BTS (Bureau of Transportation Statistics) | Записи рейсов: времена вылета/прилёта, задержки по категориям, коды отмен | Исторические (батч) |
| OurAirports | Справочник аэропортов: IATA/ICAO-коды, город, регион, координаты | Статичный справочник |
| METAR-архив | Почасовая погода: температура (t), давление (p), скорость ветра (ff), тип осадков (ww), облачность (c), видимость (vv) | Почасовая |

---

## Датасеты DataLens

| Датасет | Слой | Используется в |
|---|---|---|
| `prod_datalens_dds.airport` | DDS | Карта аэропортов, все чарты на уровне аэропорта |
| `prod_datalens_dds.flights` | DDS | Гистограммы задержек |
| `prod_datalens_dds.weather` | DDS | Таблица температуры/снега |
| `prod_datalens_dm.cancel_flights` | DM | Отмены по месяцам |
| `prod_datalens_dm.cancellation_report` | DM | Причины отмен по аэропортам |
| `prod_datalens_dm.dep_arr_report` | DM | Отчёт по вылетам/прилётам |
| `prod_datalens_dm.successful_flights` | DM | Распределение задержек |
| `prod_datalens.airport_x_weather` | Join | Чарты корреляции с погодой |
| `prod_datalens.flight_x_airport` | Join | Чарт дальности маршрутов |

---

## Аэропорты в проекте

| Код | Город | Штат |
|---|---|---|
| AVL | Asheville | North Carolina |
| FAY | Fayetteville | North Carolina |
| BIS | Bismarck | North Dakota |
| GFK | Grand Forks | North Dakota |
